name: CI

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# Cancel in-progress runs for the same workflow and branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Detect which parts of the monorepo have changed
  changes:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'apps/backend/**'
              - 'gradle/**'
              - 'gradlew'
              - 'gradlew.bat'
              - 'settings.gradle*'
              - 'build.gradle*'
            frontend:
              - 'apps/frontend/**'
              - 'package.json'
              - 'package-lock.json'

  # Backend: Build
  backend-build:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: wrapper

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Build backend with Gradle
        working-directory: ./apps/backend
        run: ./gradlew build -x test --no-daemon

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: apps/backend/build/libs/*.jar
          retention-days: 7

  # Backend: Test
  backend-test:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.backend == 'true'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: eduforum_test
          POSTGRES_USER: eduforum
          POSTGRES_PASSWORD: eduforum_test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/gradle-build-action@v3
        with:
          gradle-version: wrapper

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Run backend tests
        working-directory: ./apps/backend
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/eduforum_test
          SPRING_DATASOURCE_USERNAME: eduforum
          SPRING_DATASOURCE_PASSWORD: eduforum_test_password
          SPRING_PROFILES_ACTIVE: test
        run: ./gradlew test --no-daemon

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: apps/backend/build/reports/tests/test/
          retention-days: 14

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: apps/backend/build/test-results/test/*.xml
          retention-days: 14

  # Frontend: Build
  frontend-build:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./apps/frontend
        run: npm ci

      - name: Run linting
        working-directory: ./apps/frontend
        run: npm run lint

      - name: Run type checking
        working-directory: ./apps/frontend
        run: npm run type-check || npx tsc --noEmit

      - name: Build frontend
        working-directory: ./apps/frontend
        env:
          NODE_ENV: production
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: apps/frontend/.next/
          retention-days: 7

  # Frontend: Test
  frontend-test:
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.frontend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./apps/frontend
        run: npm ci

      - name: Run tests
        working-directory: ./apps/frontend
        run: npm test -- --coverage --passWithNoTests

      - name: Upload test coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage
          path: apps/frontend/coverage/
          retention-days: 14

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-reports
          path: apps/frontend/test-results/
          retention-days: 14

  # Summary job - requires all jobs to pass
  ci-success:
    runs-on: ubuntu-latest
    needs: [backend-build, backend-test, frontend-build, frontend-test]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.backend-build.result }}" = "failure" ] || \
             [ "${{ needs.backend-test.result }}" = "failure" ] || \
             [ "${{ needs.frontend-build.result }}" = "failure" ] || \
             [ "${{ needs.frontend-test.result }}" = "failure" ]; then
            echo "One or more jobs failed"
            exit 1
          fi
          echo "All jobs passed successfully"
