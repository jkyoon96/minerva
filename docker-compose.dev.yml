version: '3.8'

# Development overrides for docker-compose.yml
# Usage: docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

services:
  # PostgreSQL Database - Development overrides
  postgres:
    environment:
      # Use weaker password for development
      POSTGRES_PASSWORD: dev_password
    ports:
      # Expose on different port to avoid conflicts with local PostgreSQL
      - "5433:5432"
    volumes:
      # Add custom init scripts for development data
      - ./scripts/dev-seed.sql:/docker-entrypoint-initdb.d/seed.sql:ro

  # Spring Boot Backend - Development overrides
  backend:
    build:
      context: ./apps/backend
      dockerfile: Dockerfile
      # Use cache_from for faster rebuilds
      cache_from:
        - eduforum-backend:latest
    environment:
      # Development profile
      SPRING_PROFILES_ACTIVE: dev

      # Database configuration
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/eduforum
      SPRING_DATASOURCE_USERNAME: eduforum
      SPRING_DATASOURCE_PASSWORD: dev_password

      # JPA configuration - auto-update DDL
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: true
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: true

      # Debug logging
      LOGGING_LEVEL_COM_EDUFORUM: DEBUG
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB: DEBUG
      LOGGING_LEVEL_ORG_HIBERNATE_SQL: DEBUG

      # JWT configuration - shorter expiration for testing
      JWT_SECRET: dev-secret-key-for-development-only
      JWT_EXPIRATION: 3600000  # 1 hour

      # CORS - Allow all origins in development
      CORS_ALLOWED_ORIGINS: "*"

      # Actuator - expose all endpoints
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: "*"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: always

      # Enable Java remote debugging
      JAVA_TOOL_OPTIONS: "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005"
    ports:
      # Expose debug port
      - "5005:5005"
    volumes:
      # Mount source code for hot reload (if using Spring DevTools)
      - ./apps/backend/src:/app/src:ro
      - ./apps/backend/build:/app/build
    # Override command to use bootRun for development
    # command: ["./gradlew", "bootRun", "--no-daemon"]

  # Next.js Frontend - Development overrides
  frontend:
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile.dev
      cache_from:
        - eduforum-frontend:latest
    environment:
      # Development mode
      NODE_ENV: development

      # API configuration - point to local backend
      NEXT_PUBLIC_API_URL: http://localhost:8080/api
      API_URL: http://backend:8080/api

      # NextAuth configuration
      NEXTAUTH_URL: http://localhost:3000
      NEXTAUTH_SECRET: dev-secret-key-for-development-only

      # Enable debug logging
      DEBUG: "*"
    ports:
      # Default Next.js dev port
      - "3000:3000"
      # Node.js debug port
      - "9229:9229"
    volumes:
      # Mount source code for hot reload
      - ./apps/frontend/src:/app/src
      - ./apps/frontend/public:/app/public
      - ./apps/frontend/package.json:/app/package.json
      - ./apps/frontend/next.config.js:/app/next.config.js
      - ./apps/frontend/tailwind.config.ts:/app/tailwind.config.ts
      - ./apps/frontend/tsconfig.json:/app/tsconfig.json
      # Prevent overwriting node_modules
      - /app/node_modules
      - /app/.next
    # Override command to use dev server
    command: ["npm", "run", "dev"]
    # Disable healthcheck in dev mode (dev server may not have health endpoint)
    healthcheck:
      disable: true
